# 뉴스 피드 시스템 설계

- 뉴스 피드의 facebook 정의를 먼저 살펴보고 가자.

> 뉴스 피드: 홈 페이지 중앙에 지속적으로 업데이트되는 스토리들로, 사용자 상태 정보 업데이트, 사진, 비디오, 링크, 앱 활동, 그리고  
> 개인이 팔로우하는 사람들, 페이지, 또는 그룹으로부터 나오는 _좋아요(like)_ 등을 포함한다.

- 뉴스 피드 설계는 아주 유명한 면접 문제다.

## 문제 이해 및 설계 범위 확정

- 모바일 앱, 웹 모두를 지원해야 한다.
- 사용자는 뉴스 피드 페이지에 새로운 스토리를 올릴 수 있어야 하고, 친구들이 올리는 스토리를 볼 수도 있어야 한다.
  - 스토리는 시간 흐름 역순(reverse chronological order)으로 표시된다.
- 한 명의 사용자는 최대 5000명의 친구를 가질 수 있다.
- 매일 1000만 명이 방문한다.(10Million DAU)
- 스토리에는 이미지, 비디오 등의 미디어 파일이 포함될 수 있다.

---

## 개략적 설계안 제시 및 동의 구하기

- 지금부터 볼 설계안은 아래 두 가지 부분으로 나뉜다.

  - (1) 피드 발행(feed publishing):
    - 사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 데이터베이스에 기록한다. 새로운 포스팅은 친구의 뉴스 피드에도 전송된다.
  - (2) 뉴스 피드 생성(news feed building)
    - 지면 관계상 뉴스 피드는 모든 친구의 포스팅을 시간 흐름 역순으로 모아 만든다고 가정한다.

### 뉴스 피드 API

- 뉴스 피드 API는 클라이언트와 서버가 통신하기 위해 사용하는 수단이다. HTTP Protocol 기반이고, 상태 정보를 업데이트하거나, 뉴스 피드를 가져오거나,  
  친구를 추가하는 등의 다양한 작업을 수행하는 데 사용한다. 지금부터 이 가운데 가장 중요한 2개의 API를 살펴보자.

#### 피드 발행 API

- 새로운 스토리를 포스팅하기 위한 API이다. HTTP POST 형태로 요청을 보내면 된다. 아래와 같은 형태를 띤다.

- `POST /v1/me/feed`
  - 인자
    - Body: 포스팅 내용
    - Authorization header: API 호출을 인증하기 위해 사용

#### 피드 읽기 API

- 뉴스 피드를 가져오는 API로, 아래 형태를 띤다.

- `GET /v1/me/feed`
  - 인자
    - Authorization header: API 호출을 인증하기 위해 사용

### 피드 발행

- 피드 발행 시스템의 개략적 형태는 아래와 같다.

![picture 28](/images/SDI_NFS_1.png)

- 사용자: 모바일 앱이나 브라우저에서 새로운 포스팅을 올리는 주체. `POST /v1/me/feed` API를 사용한다.
- Load balancer: 트래픽을 웹 서버들로 분산한다.
- Web server: HTTP 요청을 내부 서비스로 중계하는 역할 담당
- 포스팅 저장 서비스(post service): 새로운 포스팅을 데이터베이스와 캐시에 저장한다.
- 포스팅 전송 서비스(fanout service): 새로운 포스팅을 친구의 뉴스 피드에 push 한다.  
  뉴스 피드 데이터는 캐시에 보관해 빠르게 읽어갈 수 있도록 한다.
- 알림 서비스(notification service): 친구들에게 새로운 포스팅이 올라왔음을 알리거나, push 알림을 보내는 역할을 담당한다.

### 뉴스 피드 생성

- 이번에는 사용자가 보는 뉴스 피드가 어떻게 만들어지는지 살펴보자. 아래는 개략적인 설계안이다.

![picture 29](/images/SDI_NFS_2.png)

- 사용자: 뉴스 피드를 읽는 주체. `GET /v1/me/feed` API를 사용한다.
- Load balancer: 트래픽을 웹 서버들로 분산한다.
- Web server: 트래픽을 뉴스 피드 서비스로 보낸다.
- 뉴스 피드 서비스(news feed service): 캐시에서 뉴스 피드를 가져오는 서비스
- 뉴스 피드 캐시(news feed cache): 뉴스 피드를 렌더링할 때 필요한 feed ID를 보관한다.

---
