# 주문 서비스 및 주문 생성 Saga 설계

- 주문 서비스에는 비즈니스 로직이 포함된 `OrderService`, `Order` 등의 클래스와  
  주문 생성 Saga를 오케스트레이션하는 `CreateOrderSaga` 클래스가 있다.  
  주문 서비스는 자신의 Saga에도 참여하므로 `OrderService`를 호출하여  
  커맨드 메시지를 처리하는 어댑터 클래스인 `OrderCommandHandlers`가 있다.

- 핵심 비즈니스 로직은 `OrderService`, `Order`, `OrderRepository`의 3개  
  클래스에 있다. Saga 오케스트레이터인 주문 서비스는 그 자신이 Saga의 참여자이기도 하다.  
  `CreateOrderSaga`를 비롯하여 여러 Saga 오케스트레이터를 거느리고 있다.  
  Saga 오케스트레이터는 Saga 참여자들의 proxy 클래스(`OrderServiceProxy` 등)들을  
  거쳐 Saga 참여자에게 커맨드 메시지를 전달한다. Saga 참여자 프록시는 Saga 참여자의  
  메시징 API가 정의된 클래스이다. `OrderCommandHandlers`는 Saga가 주문 서비스에  
  전송한 커맨드 메시지들을 처리한다.

<h2>OrderService</h2>

- `OrderService`는 주문 생성/관리를 담당하는 서비스 API 계층이 호출하는 도메인 서비스이다.  
  `OrderService`는 `Order`를 생성/수정하고, `OrderRepository`를 호출하여  
  `Order`를 저장하며, `SagaManager`를 이용하여 `CreateOrderSaga`와 같은  
  Saga를 생성한다. `SagaManager`는 Eventuate Tram Saga 프레임워크에서 기본 제공되는,  
  Saga 오케스트레이터와 참여자를 작성하는 클래스이다.

- 우선 지금은 `createOrder()`에 주목하자.  
  이 메소드는 먼저 주문을 생성한 후, 주문을 검증하기 위해 `CreateOrderSaga`를 생성한다.

```java
@Transactional
@RequiredArgsConstructor
public class OrderService {

    private final SagaManager<CreateOrderSagaState> createOrderSagaManager;

    private final OrderRepository orderRepository;
    private final DomainEventPublisher domainEventPublisher;

    public Order createOrder(OrderDetails orderDetails) {
	// Order 생성
	ResultWithEvents<Order> orderAndEvents = Order.createOrder(/*..*/);

	Order order = orderAndEvents.result;

	// Order를 DB에 저장
	orderRepository.save(order);

	// 도메인 이벤트 발행
	eventPublisher.publish(Order.class, Long.toString(order.getId()), orderAndEvents.events);

	// CreateOrderSaga 생성
	CreateOrderSagaState data =
	    new CreateOrderSagaState(order.getId(), orderDetails);

	createOrderSagaManager.create(data, Order.class, order.getId());

	return order;
    }
}
```

- `createOrder()`는 정적 팩토리 메소드인 `Order.createOrder()`를 호출하여  
  `Order`를 생성한 후, DB에 저장한다. 그리고 새로 저장된 `Order`및 `OrderDetails`의  
  ID가 포함된 `CreateOrderSagaState`를 `SagaManager.create()`에 넘겨  
  `CreateOrderSaga`를 생성한다. `SagaManager`가 오케스트레이터 인스턴스를 생성하면  
  곧바로 첫 번째 Saga 참여자에게 커맨드 메시지가 전달되고, Saga 오케스트레이터를  
  DB에 저장한다.

<hr/>
