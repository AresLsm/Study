<h1>Filters with Spring</h1>

<h2>DelegatingFilterProxy</h2>

- Spring은 `Filter`의 구현체 중 하나인 `DelegatingFilterProxy`라는 객체를 제공한다.  
  이 객체는 Servlet Container의 생명 주기와 Spring의 `ApplicationContext`를 이어주는 역할을 한다.

- Servlet Container에는 `Filter`들을 등록할 수 있지만, Spring Bean들에 대해서는 자체적으로 알지 못한다.  
  이를 해결하는 것이 `DelegatingFilterProxy`객체이다. 이 객체를 사용하면 Spring Bean들을 사용하는  
  `Filter`들을 Servlet Container에 등록할 수 있다.

- 아래 그림은 `DelegatingFilterProxy`가 `Filter`들과 `FilterChain`에서 하는 역할을 그린 것이다.

![picture 3](../images/9dffd3e8c7ca9a0be682b793fded9af18dbba1a3c0e3b317065a48202c70ba5a.png)

- `DelegatingFilterProxy`는 `ApplicationContext`에 있는 Bean Filter를 찾아보고, 해당 Bean Filter의  
  작업을 호출한다. 아래는 `DelegatingFilterProxy`의 Pseudo code이다.

```java
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) {
    // Spring Bean으로 등록된 Filter들을 Lazy 방식으로 찾는다.
    Filter delegate = getFilterBean(beanName);

    delegate.doFilter(request, response);
}
```

- `DelegatingFilterProxy`의 또다른 장점은 bean으로 등록된 `Filter`들을 찾는 작업을 Lazy하게 해준다는 것이다.  
  Spring은 `ContextLoaderListener`를 사용하여 Spring Bean들을 불러오는데,  
  이 과정은 `Filter` 인스턴스들이 등록되어야 할 때 까지 수행되지 않는다.  
  이것이 중요한 이유는 컨테이너가 시작되기 전에 컨테이너에 `Filter` 인스턴스들을 먼저 등록해야 하기 때문이다.  
  즉 무조건 `Filter`들이 컨테이너에 등록되는 것을 막고, Spring Bean으로 등록된 `Filter`들을 필요할 때에  
  `ContextLoaderListener`가 불러오게끔 한다는 것이다. 만약 이 과정이 생략된다면 Spring Bean으로 등록된 `Filter`들은  
  Servlet Container에 등록되지 못할 것이다.(위에서 말했듯이 Servlet Container는 Spring Bean들에 대해 모르기 때문)

<hr/>

<h2>FilterChainProxy</h2>

- Spring Security의 Servlet에 대한 지원은 `FilterChainProxy`가 담당한다.  
  `FilterChainProxy`는 Spring이 제공하는 특별한 `Filter`인데,  
  `SecurityFilterChain`을 통해 여러 개의 Security `Filter`들에게 작업을 위임할 수 있도록 한다.
  `FilterChainProxy`는 bean 객체이기에 `DelegatingFilterProxy`에 포함되어 있다.

![picture 4](../images/edaf6c53b18c7b78adfccd886d2d436bac36296555e53f650cadf3044031b1ed.png)

<hr/>

<h2>SecurityFilterChain</h2>

- `SecurityFilterChain`은 `FilterChainProxy`에 의해 사용되는데, 해당 요청에 어떤  
  Spring Security Filter들이 작동할지를 정의할 수 있다.

- 아래 그림은 `SecurityFilterChain`이 적용되는 구조이다.

![picture 5](../images/5185518b17e5c5275b968d6c45528b0d7874c15cdf4fdd59f0d54965c13dc69b.png)
