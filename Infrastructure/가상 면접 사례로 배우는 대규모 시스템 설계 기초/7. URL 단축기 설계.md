# URL 단축기 설계

## 문제 이해 및 설계 범위 확정

### 기본적 기능

- URL 단축: 주어진 원본 URL 보다 훨씬 짧게 URL을 생성해준다.
- URL Redirection: 축약된 URL로 HTTP 요청이 오면 원래 URL로 안내한다.
- 높은 가용성과 규모 확장성, 장애 감내 필요

### 개략적 추정

- 쓰기 연산: 매일 1억 개의 단축 URL 생성
- 초당 쓰기 연산: 1억 / 24 / 3600 = 1160
- 읽기 연산: 읽기 연산과 쓰기 연산의 비율이 10:1 이라 했을 때, 읽기 연산은 초당 11,600회 발생한다.
- URL 단축 서비스를 10년간 유지한다고 가정하면 대략 3650억 개의 record를 보관해야 한다.
- 축약 전 URL의 평균 길이는 100자이다.
- 10년 동안 필요한 저장 용량은 3650억 \* 100byte = 36.5TB 이다.

---

## 개략적 설계한 제시 및 동의 구하기

- API Endpoint, URL Redirection, 그리고 URL Shortening flow에 대해 살펴보자.

### API Endpoint

- 클라이언트는 서버가 제공하는 API Endpoint를 통해 서버와 통신한다. 이 endpoint를 REST 스타일로 설계해보자.  
  URL 단축기는 기본적으로 2개의 endpoint를 필요로 한다.

- (1) URL 단축용 endpoint: 새로운 단축 URL을 생성하고자 하는 클라이언트는 이 endpoint에 단축할 URL을 인자로 실어  
  POST 요청을 보내야 한다. 이 endpoint는 아래와 같은 형태를 띈다.

  - `POST /api/v1/data/shorten`
    - 인자: `{longUrl: longURLString}`
    - 반환: 단축된 URL

- (2) URL Redirection을 위한 endpoint: 단축 URL에 대해 HTTP 요청이 오면, 원래의 URL로 보내주기 위한 용도의 endpoint.  
  아래와 같은 형태를 띈다.

  - `GET /api/v1/shortUrl`
    - 반환: HTTP Redirection의 목적지가 될 원래의 URL

### URL Redirection

- 브라우저에 단축 URL을 입력하면, 단축 URL을 받은 서버는 그 URL을 원래 URL로 바꾸어서 301 응답의 `Location` header에 담아 반환한다.  
  클라이언트와 서버 사이의 통신 절차를 나타낸 그림을 보자.

![picture 11](/images/SDI_URLS_1.png)

- 여기서 유의할 점은 301 응답과 302 응답의 차이이다. 둘 다 redirection 응답이지만, 분명한 차이가 있다.

  - `301 PERMANENTLY_MOVED`: 이 응답은 해당 URL에 대한 HTTP 요청의 처리 책임이 영구적으로 `Location` header에 반환된  
    URL로 이전되었다는 응답이다. 영구적으로 이전되었으므로 브라우저는 이 응답을 caching한다. 따라서 추후 같은 단축 URL에 요청을  
    보낼 필요가 있을 때 브라우저는 cache된 원래의 URL로 요청을 보내게 된다.

  - `302 FOUND`: 이 응답은 주어진 URL로의 요청이 _"일시적으로"_ `Location` header가 지정하는 URL에 의해 처리되어야 한다는  
    응답이다. 따라서 클라이언트의 요청은 언제나 단축 URL 서버에 먼저 보내진 후에 원래 URL로 redirection 되어야 한다.

- 위 두 방법은 각기 다른 장단점을 가진다. 서버 부하를 줄이는 것이 중요하다면 첫 번째 요청만 단축 URL 서버로 전송될 것이기에 301 응답을  
  사용하는 것이 좋다. 하지만 트래픽 분석이 중요할 때는 302 응답을 쓰는 쪽이 클릭 발생률이나 발생 위치를 추적하는 데 좀 더 유리하다.

- URL Redirection을 구현하는 가장 직관적인 방법은 hash table을 사용하는 것이다.  
  Hash table에 `<단축 URL, 원래 URL>`의 쌍을 저장한다고 가정하면, URL Redirection은 아래처럼 구현될 수 있을 것이다.

  - 원래 URL = `hashTable.get(단축 URL)`
  - 301 또는 302 응답과 `Location` header에 원래 URL을 넣은 후 전송

### URL Shortening Flow

- 단축 URL이 `www.tinyurl.com/{hashValue}`와 같은 형태라고 해보자. 결국 중요한 것은 긴 URL을 hashValue로 대응시킬  
  hash function `fx`를 찾는 일이 될 것이다.

- 이 hash function은 아래의 요구사항을 만족해야 한다.

  - 입력으로 주어지는 긴 URL이 다른 값이면, hash 값도 달라야 한다.
  - 계산된 hash 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다.

---
