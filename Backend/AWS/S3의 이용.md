<h1>AWS S3 Java에서 사용하기</h1>

* AWS S3를 Java에서 사용하기 위해 AWS에서는 AWS-JAVA-SDK를 제공한다.   
  이 중 최근(2020년)에 나온 AWS-JAVA-SDK v2가 있는데,   
  이 라이브러리 중 `S3`를 사용하는 법을 정리한 것이다.

<h2>AWS S3에 Object 업로드 하기</h2>

* 기존 AWS-SDK-JAVA(v1)를 사용하여 구축한 방법은 아래와 같다.

* 우선, gradle dependency는 아래와 같다.
```gradle

// Other dependencies, configurations..

dependency {
    compile('com.amazonaws:aws-java-sdk-s3:1.11.901')
}
```

* 위 dependency는 maven repository에서 Java상에서 AWS S3를 이용하기 위한 모듈이 담겨져 있다.

* 위 모듈이 제공하는 기능을 활용하여 S3에 파일을 업로드하는 코드는 아래와 같다.
```java
import com.amazonaws.auth.AWSCredentials;
import com.amazonaws.auth.AWSStaticCredentialsProvider;
import com.amazonaws.auth.BasicAWSCredentials;
import com.amazonaws.services.s3.AmazonS3;
import com.amazonaws.services.s3.AmazonS3ClientBuilder;
import com.amazonaws.services.s3.model.CannedAccessControlList;
import com.amazonaws.services.s3.model.ObjectMetadata;
import com.amazonaws.services.s3.model.PutObjectRequest;
import com.amazonaws.util.IOUtils;
import com.banchango.auth.token.JwtTokenUtil;

import lombok.RequiredArgsConstructor;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import javax.annotation.PostConstruct;
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.util.List;

@RequiredArgsConstructor
@Service
public class S3UploaderService {

    private AmazonS3 s3Client;
    private final WarehouseImagesRepository warehouseImagesRepository;
    private final WarehousesRepository warehousesRepository;

    @Value("${aws.s3.bucket}")
    private String bucket;

    @Value("${aws.access_key_id}")
    private String accessKey;

    @Value("${aws.secret_access_key}")
    private String secretKey;

    @Value("${aws.s3.region}")
    private String region;

    @PostConstruct
    public void setS3Client() {
        AWSCredentials credentials = new BasicAWSCredentials(this.accessKey, this.secretKey);

        s3Client = AmazonS3ClientBuilder.standard()
                .withCredentials(new AWSStaticCredentialsProvider(credentials))
                .withRegion(this.region)
                .build();
    }

    // S3에 파일을 업로드 한 후 업로드된 URL 반환
    private String uploadFile(MultipartFile file) {
        try {
            ObjectMetadata objectMetadata = new ObjectMetadata();
            byte[] bytes = IOUtils.toByteArray(file.getInputStream());
            objectMetadata.setContentLength(bytes.length);
            ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(bytes);

            String fileName = file.getOriginalFilename();
            PutObjectRequest putObjectRequest = new PutObjectRequest(bucket, fileName, byteArrayInputStream, objectMetadata);
            s3Client.putObject(putObjectRequest.withCannedAcl(CannedAccessControlList.PublicRead));
            return s3Client.getUrl(bucket, fileName).toString();
        } catch(IOException exception) {
            throw new InternalServerErrorException(exception.getMessage());
        }
    }
}
```
