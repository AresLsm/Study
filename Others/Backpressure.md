# Back Pressure (배압)

## Reactive Stream에서의 배압

- Reactive Programming의 Non-Blocking에 의해, 서버는 완성된 stream을  
  보내지 않는다. 대신, 데이터가 사용 가능할 때 동시적으로 전송할 수 있다.  
  따라서 클라이언트는 응답을 받기 위해 대기하고 처리하는 시간을 줄일 수 있다.  
  하지만 해결해야할 문제점들이 있다.

- 소프트웨어 시스템에서의 backpressure(배압)은 **트래픽의 한계를 넘은 요청을 할 수 있는 능력**이다.  
  즉, 정보의 요청자들이 consumer가 데이터에 접근할 수 없음에도 불구하고 계속 요청해서  
  consumer가 부하에 걸리도록 하는 것이다.

## 배압이란?

- Reactive Stream에서, 배압은 스트림 내의 요소들의 전달을 조정하는 방식 또한 정의한다.  
  즉, consumer가 처리할 데이터량을 조절할 수 있다는 것이다.

- 위 상황을 이해하기 위해 `Publisher`, `Consumer`, 그리고 `GUI`의 세 개 서비스로 이루어진  
  시스템을 생각해보자.

  - `Publisher`는 1초마다 10000개의 이벤트를 `Consumer`에게 보낸다.
  - `Consumer`는 받은 이벤트들을 처리하고, 결과값을 `GUI`에게 보낸다.
  - `GUI`는 받은 결과값을 출력한다.
  - **`Conumser`는 오직 1초에 7500개의 이벤트만을 처리할 수 있다.**

- 위 예시의 마지막 조건을 보면, `Consumer`는 7500개만 처리할 수 있지만 `Publisher`는  
  10000개의 이벤트를 전송하고 있다. 이 상태로는 `Consumer`가 이벤트들을 올바르게 처리하지 못한다.  
  이것이 바로 배압이다. 결론적으로 시스템은 붕괴되고, `GUI`를 보는 사용자들은 결과를 보지 못할 것이다.

### 배압을 이용하여 시스템적인 오류 예방

- 위 예시로 계속 나아가서, `Consumer`의 처리 가능량보다 더 많이 들어온 이벤트들을 어떻게  
  효율적으로 관리할 수 있을지 알아보자.

  - (1) **데이터 스트림을 조작한다.**  
    근본적으로 `Publisher`가 이벤트 발행 속도를 늦춰야 한다. 이렇게 되면 `Consumer`가 부하에 걸릴  
    가능성도 없어진다. 하지만 이 방법을 사용하지 못하는 상황도 분명히 존재한다.
  - (2) **처리량을 초과하는 이벤트들을 버터링한다.**  
    이 방법에서 `Consumer`는 초과하는 이벤트들을 잠시 모아두고, 처리 가능할 때 처리하게 된다.  
    이 방식의 가장 큰 문제점은 버퍼를 사용할 때 자칫하면 메모리가 깨질 수 있다는 점이다.
  - (3) **초과적인 이벤트들은 그냥 무시한다.**  
    최선의 방법은 아니지만, 적어도 시스템이 붕괴하진 않는 방법이다.

### 배압 조절하기

- `Publisher`에 의해 발생한 이벤트들을 조절하는 방법을 살펴보자.  
  위와 마찬가지로 세 개의 후보가 있다.

  - (1) **`Subscriber`가 요청할 때만 새로운 이벤트를 보낸다.**
  - (2) **`Subscriber`에서 받을 수 있는 이벤트들의 한계치를 줄인다.**  
    이렇게 하면 `Publisher`는 한 번에 `Subscriber`가 처리할 수 있는 최대  
    정보량만 보낸다.
  - (3) **`Consumer`가 더 이상 이벤트들을 처리할 수 없을 때 데이터 스트림을 끊는다.**

<hr/>
