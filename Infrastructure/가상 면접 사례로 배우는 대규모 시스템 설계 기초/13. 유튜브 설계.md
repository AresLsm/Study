# Youtube 설계

## 문제 이해 및 설계 범위 확정

- 유튜브에서는 단순히 비디오를 보는 것 말고도 많은 일을 할 수 있다. 댓글 남기기, 비디고 공유 및 좋아요 버튼 클릭, 재생 목록에 추가,  
  채널 구독 등도 할 수 있다. 이 모두를 설계하는 것은 사실상 불가능하니, 설계 범위를 좁혀보자.

- 비디오를 올리는 기능, 시청하는 기능에 집중한다.
- 모바일 웹, 웹 브라우저, 스마트 TV를 지원한다.
- DAU는 500만이다.
- 사용자는 평균적으로 30분동안 서비스를 사용한다.
- 다국어 지원이 가능해야 한다.
- 현존하는 비디오 종류와 해상도를 대부분 지원해야 한다.
- 암호화가 필요하다.
- 비디오의 최대 크기는 1GB이다.
- 클라우드 서비스를 활용해도 좋다.

- 이번 장에서는 아래와 같은 기능을 갖춘 비디오 스트리밍 서비스 설계에 초점을 맞출 것이다.

  - 빠른 비디오 업로드
  - 원활한 비디오 재생
  - 재생 품질 선택 기능
  - 낮은 인프라 비용
  - 높은 가용성과 규모 확장성, 그리고 안정성
  - 지원 클라이언트: 모바일 웹, 웹 브라우저, 스마트 TV

### 개략적 규모 추정

- DAU: 500만 명
- 한 사용자는 하루에 평균 5개의 비디오 시청
- 10%의 사용자는 하루에 1개의 비디오 업로드
- 비디오의 평균 크기는 300MB(0.3GB)
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량 = `500만 * 10% * 300MB = 150TB`
- CDN 비용
  - 클라우드 CDN을 통해 비디오를 서비스할 경우 CDN에서 나가는 데이터량에 비례해 과금된다.
  - AWS CloudFront를 사용할 경우 100%의 트래픽이 미국에서 발생한다 가정하면 1GB당 $0.02의 요금이 발생한다.
  - 따라서 매일 발생하는 요금은 `500만 * 5개 비디오 * 0.3GB * $0.02 = $150,000`이다.

---

## 개략적 설계안 제시 및 동의 구하기

> 앞서 클라우드 서비스를 사용해도 좋다고 했다. 따라서 여기서 볼 CDN과 BLOB storage는 기존 클라우드 서비스를 활용할 것이다.
> 왜 전부 직접 만들지 않을까? 그 이유는 아래와 같다.
>
> - 시스템 설계 면접은 모든 것을 밑바닥부터 만드는 것과는 관계가 없다. 주어진 시간 내에 적절한 기술을 골라 설계를 마치는 것이  
>   그 기술 각각이 어떻게 동작하는지 상세히 설명하는 것보다 중요하다. 예를 들어 비디오를 저장하기 위해 BLOB Storage를 사용할 것이라면  
>   그 사실만 언급해도 충분하다.
>
> - 규모 확장이 쉬운 BLOB Storage나 CDN을 만드는 것은 지극히 복잡할 뿐 아니라 많은 비용이 드는 일이다. Netflix나 Facebook같은  
>   큰 회사도 모든 것을 스스로 직접 구축하지 않는다. Netflix는 AWS, Facebook은 Akamai의 CDN을 이용한다.

- 개략적으로 보면, 이 시스템은 아래의 세 개 컴포넌트로 구성된다.

![picture 23](/images/SDI_YT_1.png)

- Client: 컴퓨터, 모바일 폰, 스마트 TV를 통해 유튜브를 시청할 수 있다.
- CDN: 비디오는 CDN에 저장한다. 재생 버튼을 누르면 CDN으로부터 스트리밍이 이뤄진다.
- API Server: 비디오 스트리밍을 제외한 모든 요청은 API Server가 처리한다.  
  Feed recommendation, 비디오 업로드 URL 생성, 메타데이터 데이터베이스와 cache 갱신, 사용자 가입 등등을 처리하게 된다.

- 지금부터 아래 두 영역을 개략적으로 설계해 볼 것이다.

  - 비디오 업로드 절차
  - 비디오 스트리밍 절차

### 비디오 업로드 절차

- 아래 그림은 비디오 업로드 절차의 개략적 설계안이다.

![picture 24](/images/SDI_YT_2.png)

- 사용자: 컴퓨터, 모바일 폰 혹은 스마트 TV를 통해 유튜브를 시청하는 이용자
- Load Balancer: API Server 각각으로 요청을 고르게 분산하는 역할 담당
- API Server: 비디오 스트리밍을 제외한 다른 모든 요청 처리
- Metadata Database: 비디오의 메타데이터 보관  
  Sharding과 Replication을 적용해 성능 및 가용성 요구사항을 충족한다.
- Metadata Cache: 성능을 높이기 위해 비디오의 메타데이터와 user object는 caching한다.
- Original Storage: 원본 비디오를 보관할 대형 이진 파일 저장소로, BLOB(Binary Large Object storage) 시스템이다.  
  BLOB Storage는 _"이진 데이터를 하나의 개체로 보관하는 데이터베이스 관리 시스템"_ 이다.
- Transcoding Server: 비디오 transcoding은 비디오 encoding이라 부르기도 하는 절차로, 비디오의 포맷(MPEG, HLS 등)을 변환하는 절차다.  
  단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기 위해 필요하다.
- Transcoded Storage: Transcoding이 완료된 비디오를 저장하는 BLOB Storage이다.
- CDN: 비디오를 cache하는 역할을 담당한다. 사용자가 재생 버튼을 누르면 비디오 스트리밍은 CDN을 통해 이뤄진다.
- Transcoding Completion Queue: 비디오 transcoding 완료 이벤트들을 보관할 message queue
- Transcoding Completion Handler: Transcoding Completion Queue에서 이벤트 데이터를 꺼내 Metadata Cache와 Database를 갱신할 작업 서버

- 각 컴포넌트들이 어떤 일을 하는지 살펴봤으니, 비디오가 업로드가 어떻게 처리되는지를 들여다보자. 아래 두 프로세스가 병렬적으로 수행된다 보면 된다.

  - (a) 비디오 업로드
  - (b) 비디오 메타데이터 갱신. 메타데이터에는 비디오 URL, 크기, 해상도, 포맷, user data가 포함된다.

#### (a): 비디오 업로드

- 아래 그림은 비디오 업로드의 과정을 보여준다.

![picture 25](/images/SDI_YT_3.png)

- 각 과정을 요약해 살펴보자.

  - (1) 비디오를 Original Storage에 업로드한다.
  - (2) Transcoding Server는 Original Storage에서 해당 비디오를 가져와 transcoding을 시작한다.
  - (3) Transcoding이 완료되면 아래의 두 절차가 병렬적으로 수행된다.
    - (3a) 완료된 비디오를 Transcoded Storage로 업로드한다.
      - (3a-1) Transcoding이 끝난 비디오를 CDN에 올린다
    - (3b) Transcoding 완료 이벤트를 Transcoding Completion Queue에 넣는다.
      - (3b-1): Transcoding Completion Handler가 이벤트 데이터를 queue에서 꺼낸다.  
        이후 Metadata Database와 Metadata Cache를 갱신한다.
  - (4) API Server가 단말에게 비디오 업로드가 끝나서 스트리밍 준비가 완료되었음을 알린다.

#### (b): 비디오 메타데이터 갱신

- Original Storage에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API Server에 보낸다.  
  이 요청에 포함된 메타데이터에는 파일명, 크기, 포맷 등의 정보가 들어있다. API Server는 이 정보로 Metadata Cache와  
  Metadata Database를 갱신한다.

### 비디오 스트리밍 절차

- 유튜브에서 비디오 재생 버튼을 누르면 스트리밍은 바로 시작되며, 비디오 다운로드가 완료되어야 영상을 볼 수 있다거나 하는 불편함은 없다.  
  여기서 _다운로드_ 라 함은 영상을 단말로 내려 받는 것을 말하며, 스트리밍은 장치가 원격지의 비디오로부터 지속적으로 비디오 스트림을  
  전송받아 영상을 재생하는 것을 말한다.

- 그런데 비디오 스트리밍이 이뤄지는 절차를 보기에 앞서, 먼저 streaming protocol이라는 중요한 개념을 알아둬야 한다.  
  Streaming protocol은 비디오 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신 방법이다.  
  널리 사용되는 streaming protocol로는 아래와 같은 것들이 있다.

  - MPEG-DASH: MPEG는 "Moving Picture Experts Group"의 약어이며, DASH는 "Dynamic Adaptive Streaming over HTTP"의 약어이다.
  - Apple HLS: HLS는 "HTTP Live Streaming"의 약어이다.
  - Microsoft Smooth Streaming
  - Adobe HTTP Dynamic Streaming(Adobe HDS)

- 이 프로포콜의 동작 원리를 정확히 이해하거나 이름들을 외울 필요는 없다. 구현 세부 사항에 해당하는 부분일 뿐인데다, 확실히 이해하려면  
  관련 분야의 도메인 지식을 알아야 하기 때문이다. 다만 기억해야 할 것은 **프로토콜마다 지원하는 비디오 encoding이 다르고, 플레이어도 다르다는 것** 이다.  
  따라서 비디오 스트리밍 서비스를 설계할 때는 서비스의 용례에 맞는 프로토콜을 잘 골라야 한다.

- 비디오는 CDN에서 바로 스트리밍된다. 사용자의 단말에 가장 가까운 CDN Edge Server가 비디오 전송을 담당할 것이기에 latency는 아주 낮다.  
  아래 그림은 이 부분의 개략적 설계안이다.

![picture 26](/images/SDI_YT_4.png)

---
