# 도메인 이벤트 발행

- **DDD 맥락에서 도메인 이벤트는 Aggregate에 발생한 사건**이다.  
  도메인 이벤트는 도메인 모델에서는 클래스로 표현되며, 대부분 어떤 상태의  
  변경을 나타낸다. 가령 `Order` Aggregate라면 _주문 생성됨_,  
  _주문 취소됨_, _주문 배달됨_ 등 상태가 바뀌는 이벤트가 발생한다.  
  Aggregate는 상태가 전이될 때마다 이에 관련된 consumer를 위해  
  이벤트를 발행한다.

> 도메인 이벤트: Aggregate는 뭔가 생성되거나 중요한 변경이 발생했을 때  
> 도메인 이벤트를 발행한다.

<h2>변경 이벤트를 발행하는 이유</h2>

- 다른 구성원(사용자, 다른 애플리케이션 또는 같은 애플리케이션 내부의 다른 컴포넌트)들이  
  Aggregate의 상태 변경을 궁금해 하기 때문에 도메인 이벤트는 유용하다.  
  아래와 같은 상황을 생각해보자.

  - 코레오그래피 Saga를 이용하여 여러 서비스게 걸쳐 데이터 일관성을 유지한다.
  - 레플리카를 둔 서비스에 소스 데이터가 변경됨을 알린다.(CQRS)
  - 미리 등록된 webhook이나 메시지 브로커를 통해 비즈니스 프로세스의 다음 단계를  
    진행하도록 다른 애플리케이션에 알린다.
  - 사용자 브라우저에 web socket 메시지를 보내거나, elasticsearch같은 텍스트 DB를  
    업데이트하기 위해 같은 애플리케이션의 다른 컴포넌트에 알린다.
  - 사용자에게 텍스트 메시지나 이메일 등으로 알린다.
  - 애플리케이션이 제대로 작동되고 있는지 도메인 이벤트를 모니터링하면서 확인한다.
  - 사용자 행동을 모델링하기 위해 이벤트를 분석한다.

- 애플리케이션 DB에서의 Aggregate 상태 전이가 이 모든 상황에서 알림을  
  트리거하는 장본인이다.

<hr/>

<h2>도메인 이벤트란 무엇인가?</h2>

- 도메인 이벤트는 과거 분사형 동사로 명명한 클래스이다.  
  이벤트에 의미를 부여하는 프로퍼티가 있는데, 프로퍼티는 primitive value 또는  
  Value Object이다. 가령 `OrderCreated` 이벤트 클래스에는 orderId 프로퍼티가 있다.

- 도메인 이벤트의 대부분에는 이벤트 ID, timestamp 같은 메타데이터도 있다.

- 변경을 일으킨 사용자의 신원 정보를 넣기도 하는데, 감사(audit) 용도로 좋다.  
  메타데이터는 상위 클래스에 정의된 이벤트 객체의 일부이거나, 이벤트 객체를 감싼 envelope 객체에 있다.  
  이벤트를 발생시킨 Aggregate ID는 특정 이벤트의 프로퍼티가 아닌 envelope 객체의  
  일부일 수 있다.

- `OrderCreatedEvent`도 도메인 이벤트이다.  
  주문 ID가 래퍼의 일부이기 때문에 필드가 하나도 없다.

```java
interface DomainEvent { }

interface OrderDomainEvent extends DomainEvent { }

class OrderCreatedEvent implements OrderDomainEvent { }

interface DomainEventEnvelope<T extends DomainEvent> {
    String getAggregateId();
    Message getMessage();
    String getAggregateType();
    String getEventId();

    T getEvent();
}
```

- `DomainEvent` 인터페이스는 자신을 구현한 클래스가 도메인 이벤트임을 알리는  
  Marker Interface이다. 이 인터페이스를 상속한 `OrderDomainEvent`는  
  `Order` Aggregate가 발행한 `OrderCreatedEvent`의 marker interface이다.  
  `DomainEventEnvelope`에는 이벤트 객체 및 메타데이터를 조회하는 메소드가 있다.  
  이 인터페이스는 `DomainEvent`를 상속한 매개변수화 객체를 받는다.

<hr/>
