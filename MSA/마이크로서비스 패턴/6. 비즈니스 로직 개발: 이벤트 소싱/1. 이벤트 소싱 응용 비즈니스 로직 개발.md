# 이벤트 소싱 응용 비즈니스 로직 개발

- **이벤트 소싱(Event Sourcing)** 은 비즈니스 로직을 구성하고, Aggregate를 저장하는  
  또다른 방법이다. Aggregate를 일련의 이벤트 형태로 저장하는 것이다. 이벤트는 각  
  Aggregate의 상태 변화를 나타낸다. 애플리케이션은 이벤트를 재연(replay)하여 Aggregate의  
  현재 상태를 재생성할 수 있다.

> 이벤트 소싱: 상태 변화를 나타내는 일련의 도메인 이벤트로 Aggregate를 저장한다.

- 이벤트 소싱은 여러모로 장점이 많다. Aggregate의 이력이 보존되므로 감사, 통제 용도로도  
  가치가 있고, 도메인 이벤트를 확실하게 발행할 수 있어서 MSA에 특히 유용하다. 물론 단점도 있다.  
  비즈니스 로직을 작성하는 방법이 특이해서 어느 정도 러닝 커브가 있고, 이벤트 저장소를  
  쿼리하기가 쉽지 않아 CQRS 패턴을 잘 적용해야 한다.

## 기존 영속화의 문제점

- 클래스는 DB 테이블에, 클래스 필드는 테이블 컬럼에, 클래스 인스턴스는 테이블의 각 row에 매핑하는 것이  
  기존의 영속화 방식이다. 일반적으로 JPA 같은 ORM 프레임워크나 MyBatis 등의 저수준 프레임워크를  
  사용하여 클래스 인스턴스를 테이블의 row 단위로 저장한다.

- 엔터프라이즈 애플리케이션은 대부분 이런 식으로 데이터를 저장한다.  
  작동은 잘 되지만, 아래와 같은 몇 가지 단점과 한계가 있다.

  - 객체 - 관계 임피던스 부정합(Object-Relational Impedance Mismatch)
  - Aggregate 이력이 없다.
  - 감사 로깅을 구현하기가 번거롭고, 에러가 잘 난다.
  - 이벤트 발행 로직이 비즈니스 로직에 추가된다.

### 객체 - 관계 임피던스 부정합

- 객체-관계 임피던스 부정합은 아주 오래된 문제다. 테이블 형태의 관계형 스키마와 관계가 복잡한  
  리치 도메인 모델(Rich Domain Model)의 그래프 구조는 근본적인 개념부터 다르다.  
  결국 이 문제는 ORM 프레임워크의 타당성에 대한 논쟁을 불붙은 바 있다.  
  Ted Neward는 _'객체-관계 매핑은 컴퓨터 과학의 월남전이다.'_ 라고 말했다.

### Aggregate이력이 없다.

- 기존 영속화 메커니즘은 현재 Aggregate의 상태만 저장한다. 즉, Aggregate가 업데이트되면  
  이전 상태는 사라지고 없다. 따라서 Aggregate 이력을 관리 용도로 온전히 보존하려면  
  개발자가 직접 코드를 구현하는데에 시간이 걸리고, 비즈니스 로직과 동기화해야 하는 코드를  
  중복 생성하게 된다.

### 감사 로깅을 구현하기가 번거롭고, 에러가 잘 난다.

- 감사 로깅 또한 문제이다. 많은 애플리케이션은 어느 사용자가 Aggregate를 변경했는지 감사 로그를  
  남겨 추적한다. 감사는 보안 및 통제 때문에도 필요하지만, 사용자 액션 이력 자체가 중요한 경우도 있다.  
  가령 Asana, Jira와 같은 Issue Tracker나 태스크 관리 애플리케이션들은 변경 이력을 task, issue로  
  표시한다. 감사 로깅은 구현하는 데에 시간이 걸리는 것도 문제이지만, 감사 로깅 및 비즈니스 로직이 계속  
  분화하기 때문에 버그가 날 가능성도 높다.

### 이벤트 발행 로직이 비즈니스 로직에 추가된다.

- 기존 영속화의 또 다른 한계는 도메인 이벤트 발행을 지원하지 않는 점이다. 도메인 이벤트는 Aggregate가  
  자신의 상태를 변경한 후 발행하는 이벤트다. MSA에서는 데이터를 동기화하고 알림을 전송하는 용도로 유용하게  
  쓰인다. ORM 프레임워크는 데이터 객체가 변경될 때 애플리케이션이 제공한 callback을 호출할 수 있지만,  
  데이터를 업데이트하는 트랜잭션의 일부로 메시지를 자동 발행하는 기능 따위는 없다. 따라서 이력, 감사도 그랬듯이  
  개발자는 이벤트 생성 로직을 추가해야 하는데, 자칫 비즈니스 로직과 동기화되지 않을 위험이 있다.

- 위 한계점들을 극복해주는 기법이 바로 이벤트 소싱이다.

<hr/>
