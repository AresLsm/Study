# 스레드

- Thread는 CPU 이용의 기본 단위이다. 아래의 구성 요소들로 이뤄져 있다.

  - Thread ID
  - Program Counter
  - Register 집합
  - Stack

- 대부분의 현대 응용프로그램들은 다중스레드를 사용하며, 스레드는 응용프로그램 내에서 실행된다.

- 여러 작업을 해야 하는 응용프로그램은 각 작업별로 스레드를 생성해서 구현할 수 있다.

- 스레드 생성은 프로세스를 생성하는 것에 비해 할 일이 적고, 시간도 덜 드는 작업이다.

- 커널은 일반적으로 다중스레드로 구현된다.

## 다중스레드 아키텍쳐의 이점

- 반응성: 긴 작업이 수행되더라도 프로그램의 다른 부분의 수행이 계속되게 한다.
- 자원 공유: 프로세스는 공유메모리 또는 메시지 전달 기법을 통해서만 자원을 공유할 수 있고, 이러한 기법은 프로그래머들에 의해 명시적으로  
  처리되곤 한다. 하지만 스레드는 자동적으로 그들이 속한 프로세스 내의 자원들과 메모리를 공유할 수 있으며, 이렇게 한 응용프로그램이 같은  
  주소 공간 내에 여러 개의 다른 작업을 하는 스레드를 가질 수 있다.
- 경제성: 스레드의 생성 비용은 프로세스의 생성 비용에 비해 적다. 스레드는 자신이 속한 프로세스의 자원들을 공유하기 때문에 스레드를 생성하고  
  context switching을 하는 것이 더 경제적이다.
- 확장성: 확장성은 다중스레드 구조에서 더 증가하는데, 각각의 스레드가 다른 처리기에서 병렬로 수행될 수 있기 때문이다.

## 멀티코어 프로그래밍

- 코어가 여러 개의 CPU칩의 형태를 띄거나 칩 안에 여러 개의 CPU가 존재하면 이를 Multicore 또는 Multiprocessor라 한다.

- 멀티스레드 프로그램은 다중 계산 코어를 더 효율적으로 사용할 수 있게 하고, 병행 실행을 더 향상시킬 수 있는 기법을 제공한다.

  - 병렬 수행(Parallelism): 두개 이상의 task를 동시에 실행하는 것
  - 병행 수행(Concurrency): 두 개 이상의 task가 진행될 수 있도록 하는 것.

## 멀티코어 프로그래밍 도전 과제

- Task 식별(Identifying tasks)
- 활동 분할(dividing activities)
- 균형 맞추기(balance)
- 데이터 쪼개기(Data splitting)
- 데이터 의존성(Data dependency)
- 검증 및 디버깅(Testing and debugging)

### 병렬 수행 유형

- 데이터 병렬 수행(Data parallelism): 동일한 데이터의 일부를 여러 코어에 분배하고, 각 코어에서 동일한 연산 수행
- 태스크 병렬 수행(Task parallelism): 코어에 스레드를 분배하고, 각 스레드는 자신만의 연산 수행

## 다중스레드 모델

- User threads(사용자 스레드): 사용자 수준 스레드 라이브러리에 의해 관리되는 스레드로, 세 가지 주요 스레드 라이브러리가 있다.

  - POSIX Pthreads
  - Windows threads
  - Java threads

- Kernel threads(커널 스레드): 커널에서 지원하는 스레드

### 사용자 스레드와 커널 스레드의 연관 관계

- Many-To-One(Pure user level)

  - 다수의 사용자 수준 스레드가 하나의 커널 스레드에 매핑된다.
  - 한 개의 스레드가 블록되면 다른 모든 스레드도 블록된다.
  - 다중코어 시스템에서 실행되더라도 여러 스레드가 병렬로 실행될 수 없다.
    - 한 순간에 오직 하나의 사용자 스레드만이 커널에 존재할 수 있기 때문
  - 라이브러리가 직접 스케쥴링을 하고 작업에 필요한 정보를 처리하기에 context switching이 필요 없다.
  - 현재 이 모델을 사용하는 시스템은 거의 없다.

- One-To-One(Pure kernel level)

  - 각 사용자 스레드는 커널 스레드로 매핑된다.
  - 사용자 스레드를 생성하면 커널 스레드도 함께 생성된다.
  - Many-To-One model보다 병행 수행을 더 많이할 수 있다.
  - 프로세스 당 스레드의 개수는 오버헤드 때문에 제한된다.
  - **커널 레벨에서 모든 작업을 지원하기에 멀티 CPU를 사용할 수 없다.**
  - Context switching의 오버헤드 때문에 느리게 작동한다.

- Many-To-Many(Combined)

  - 여러 개의 사용자 수준 스레드를 그보다 작거나 같은 수의 커널 스레드로 Multiplexing한다.
  - 응용 프로그램은 단일 처리기보다 다중처리기에서 더 많은 커널 스레드를 할당한다.
  - 커널 스레드를 사용하기에 여전히 context switching이 있고, 따라서 느리게 동작한다.
  - **빠르게 움직여야 하는 스레드는 사용자 스레드로 작동, 안정적으로 움직여야 하는 스레드는 커널 스레드로 작동**한다.

- Two-Level

  - Many-To-Many와 유사하지만, 하나의 사용자 스레드가 하나의 커널 스레드와 연관되는 것을 허용한다.
