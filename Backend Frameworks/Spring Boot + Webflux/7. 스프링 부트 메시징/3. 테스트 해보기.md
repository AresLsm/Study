# 테스트 해보기

## 테스트 컨테이너 사용 테스트

- 이제 테스트 컨테이너를 사용할 준비를 마쳤다.  
  이제 테스트 대상 시스템에 어떤 동작을 테스트할지 먼저 정해보자.  
  지금까지 비동기 메시징 솔루션에 대해 이야기했는데, 웹 컨트롤러에서  
  새로운 `Item`객체의 생성 요청을 받아 RabbitMQ를 통해 메시지로  
  전달하는 과정을 구현해보자. 메시지를 받아서 MongoDB에 저장하는  
  서비스도 함께 구현할 것이다.

- 메시지를 매개체로 사용하는 이 단순한 개념은 여러 방식으로 응용해서 얼마든지 재사용할 수 있다.  
  예를 들어, 웹 컨트롤러 대신 다른 것으로 대체할 수도 있다. 그렇게 해도 메시지는  
  RabbitMQ를 통해 전송된다. 또는 메시지를 전송하는 API를 직접 호출하게 할 수도 있다.

- 일단 처음에 시도하려 했던 것부터 해보자. 동기적인 웹 요청을 받아서 비동기 메시지로 바꾸는  
  웹 컨트롤러를 만들어봊. 이번에는 테스트를 먼저 작성하는 방식으로 진행해보자.

```kt
@SpringBootTest // (1)
@AutoConfigureWebTestClient // (2)
@Testcontainers // (3)
@ContextConfiguration // (4)
class RabbitMQTest {

    companion object {
        @Container
        val container = RabbitMQContainer("rabbitmq:3.7.25-management-alpine") // (5)

        @DynamicPropertySource // (6)
        fun configure(registry: DynamicPropertyRegistry) {
            registry.add("spring.rabbitmq.host", container::getContainerIpAddress)
            registry.add("spring.rabbitmq.port", container::getAmqpPort)
        }
    }

    @Autowired
    private lateinit var webTestClient: WebTestClient

    @Autowired
    private lateinit var repository: ItemRepository
}
```

- 위 코드에 대한 설명은 아래와 같다.

  - (1) `@SpringBootTest`는 자동설정, 환경설정 값 읽기, 내장 웹 컨테이너 등 테스트를 위한  
    애플리케이션 구동에 필요한 모든 것을 활성화한다. 기본적으로 실제 운영환경이 아니라 실제 운영환경을  
    mocking한 환경을 사용한다.

  - (2) `@AutoConfigureWebTestClient`를 적용해서 테스트용으로 사용하는 webClient인  
    `WebTestClient`를 자동설정한다.

  - (3) `@TestContainer`는 JUnit5에서 제공하는 어노테이션으로, 테스트컨테이너를 테스트에  
    사용할 수 있게 해준다.

  - (4) `@ContextConfiguration`은 지정한 클래스를 테스트 실행 전에 먼저 Application Context에  
    로딩해준다.

  - (5) 테스트에 사용할 `RabbitMQContainer`를 생성한다. `RabbitMQContainer`는 테스트에 사용할  
    RabbitMQ 인스턴스를 관리한다.

  - (6) `@DynamicPropertySource`는 Java8의 함수형 인터페이스인 `Supplier`를 사용해서  
    환경 설정 내용을 `Environment`에 동적으로 추가한다. `container::getContainerIpAddress`와  
    `container::getAmqpPort` 메소드 핸들을 사용해서 테스트컨테이너에서 실행한 RabbitMQ 브로커의  
    호스트명과 포트 번호를 가져온다. 이렇게 하면 RabbitMQ 연결 세부 정보를 테스트컨테이너에서 읽어와서  
    Spring AMQP에서 사용할 수 있도록 스프링 부트 환경설정 정보에 저장한다.

- 테스트를 작성하기 전에 먼저 알아야할 것이 있다. 지금까지 Project Reactor를 사용하는  
  테스트에서는 `StepVerifier`를 사용해서 비동기 처리 흐름을 쉽게 테스트할 수 있었고,  
  지연 효과를 흉내낼 수도 있었다. 하지만 RabbitMQ를 사용하는 테스트에서는 `RabbitVerifier`같은  
  것이 없어서 `Thread.sleep()`을 사용해야 한다.

- 그런데 이번에는 테스트를 작성하기 전에 어떤 스프링 프로젝트를 사용해야 되는지 아무런 언급이  
  없었다는 것이 이상하지 않은가? 왜냐하면 아직 테스트 대상조차 없는 상태에서 테스트를 먼저 작성하는  
  test-first 전략을 사용하기 때문이다.

<hr/>

## 테스트 케이스 구성
