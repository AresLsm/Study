<h1>대역</h1>

<h2>대역의 필요성</h2>

* 테스트를 작성하다 보면 외부 요인이 필요한 시점이 있다. 아래는 외부 요인이 테스트에 관여하는 주요 예시이다.
  * 테스트 대상에서 파일 시스템을 사용하는 경우
  * 테스트 대상에서 DB로부터 데이터를 조회하거나 데이터를 추가하는 경우
  * 테스트 대상에서 외부의 HTTP 서버와 통신하는 경우

* 테스트 대상이 이런 외부 요인에 의존하면 테스트를 작성하고 실행하기 어려워진다. 테스트 대상 코드에서 사용하는   
  외부 API 서버가 일시적으로 장애가 나면 테스트를 원활하게 수행할 수 없다. 내부에서 사용하는 DB라도 상황에 맞게   
  데이터를 구성하는 것이 항상 가능한 것은 아니다.

* 외부 API를 사용하는 자동이체 서비스의 경우, 외부 업체가 제공하는 API를 이용하여 카드번호의 유효성을 검증한다.   
  이 기능을 테스트하려면 정상 카드번호, 도난 카드번호, 만료일이 지난 카드 번호가 필요하기 때문에 외부 업체에서   
  상황별로 테스트할 수 있는 카드번호를 받아와야 한다.

* TDD는 `테스트 작성 --> 통과시킬 만큼 구현 --> 리팩토링`의 과정을 짧은 흐름으로 반복해야 하는데 외부 업체에서   
  상황별 카드번호를 제공하지 않으면 테스트를 진행할 수 없게 된다.

* 이처럼 외부 요인은 테스트 작성을 어렵게 만들 뿐만 아니라 테스트 결과도 예측할 수 없게 만든다.   
  실제 예시 코드로 살펴보자.
```java
public class AutoDebitRegister {

    private CardNumberValidator validator;
    private AutoDebitInfoRepository repository;

    public AutoDebitRegister(CardNumberValidator validator, AutoDebitInfoRepository repository) {
        this.validator = validator;
        this.repository = repository;
    }

    public RegisterResult register(AutoDebitRequest request) {
        CardValidity validity = validator.validate(request.getCardNumber());
        if(validity != CardValidity.VALID) {
            return RegisterResult.error(validity);
        }
        AutoDebitInfo info = repository.findOne(request.getUserId());
        if(info != null) {
            info.changeCardNumber(request.getCardNumber());
        } else {
            AutoDebitInfo newInfo = new AutoDebitInfo(request.getUserId(), request.getCardNumber(),
                LocalDateTime.now());
            repository.save(newInfo);
        }
        return RegisterResult.success();
    }
}
```

* `AutoDebitRegister` 클래스에서 사용하는 `CardNumberValidator` 클래스는 아래와 같다.
```java
public class CardNumberValidator {

    public CardValidity validate(String cardNumber) {
        HttpClient httpClient = HttpClient.newHttpClient();
        HttpRequest request = HttpRequest.newBuilder()
            .uri(URI.create("SOME URL"))
            .header("Content-Type", "text/plain")
            .POST(BodyPublishers.ofString(cardNumber))
            .build();
        
        try {
            HttpResponse<String> response = 
                httpClient.send(request, BodyHandlers.toString());
            switch(response.body()) {
                case "ok": return CardValidity.VALID;
                case "bad": return CardValidity.INVALID;
                case "expired": return CardValidity.EXPIRED;
                case "theft" : return CardValidity.THEFT;
                default: return CardValidity.UNKNOWN;
            }
        } catch(IOException | InterruptedException exception) {
            return CardValidity.ERROR;
        }
    }
}
```

* 이제 `AutoDebitRegister`를 테스트하는 코드를 작성해보자.
```java
public class AutoDebitRegisterTest {
    private AutoDebitRegister register;

    @BeforeEach
    void setUp() {
        CardNumberValidator validator = new CardNumberValidator();
        AutoDebitInfoRepository repository = new JpaAutoDebitInfoRepository();
        register = new AutoDebitRegister(validator, repository);
    }

    @Test
    void validCard() {
        // 업체에서 받은 테스트용 유효한 카드번호 사용
        AudoDebitRequest request = new AutoDebitRequest("user1", "1234123412341234");
        RegisterResult result = this.register.register(request);
        assertEquals(CardValidity.VALID, result.getValidity());
    }

    @Test
    void theftCard() {
        // 업체에서 받은 도난 테스트용 카드 번호
        AutoDebitRequest request = new AutoDebitRequest("user1", "1231231231231231");
        RegisterResult result = this.register.register(request);
        assertEquals(CardValidity.THEFT, result.getValidity());
    }
}
```

* 위 코드에서 `validCard()` 테스트를 통과시키려면 외부 업체에서 테스트 목적의 유효한 카드 번호를 받아야 한다. 만약 이 카드번호가   
  한달 뒤에 만료되면 `validCard()` 테스트는 한달 뒤부터 실패한다. 비슷하게 테스트 용도의 도난 카드 정보를 외부 업체에서 삭제하면   
  `theftCard()` 테스트도 실패하게 될 것이다.

* 이렇게 테스트 대상에서 의존하는 요인 때문에 테스트가 어려울 때는 `대역`을 써서 테스트를 진행할 수 있다.   
  난이도가 높은 액션이 필요할 때 배우를 대신해서 연기하는 스턴트맨처럼 테스트에서는 외부 요인으로 인해 테스트가 어려울 때   
  외부 요인을 대신하는 대역이 외부 요인을 대신해서 테스트에 참여한다.
<hr/>