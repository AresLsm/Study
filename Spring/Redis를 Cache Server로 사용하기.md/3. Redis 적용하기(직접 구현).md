# Redis 적용하기(직접 구현)

<h2>기존 상황</h2>

- 간단한 상황을 살펴보자. 사용자(User)의 정보를 Redis에 저장하고 싶다.  
  사용자는 userId, email, name의 필드들을 가지며 아래는 기존의 서비스 코드이다.

```kt
@Service
class UserService(private val findUser: FindUser) {

    @Transactional(readOnly = true)
    fun getUserInfo(): UserInfoResponseDto {
        val user = findUser.get()
        return UserInfoResponseDto(user)
    }
}
```

- 위 코드가 포함된 전체 코드는 readme에 있는 링크에서 볼 수 있다.

- 위 코드 대로라면, 사용자가 사용자 정보를 조회하는 API를 호출할 때 마다 데이터베이스에서  
 해당 사용자의 정보를 READ해와야 한다.  
 이제 Cache를 적용해서 Redis에 이미 정보가 있다면 Redis에서 읽어오고, 없다면 데이터베이스에서 가져오도록 해보자.  
 Cache를 지원하는 라이브러리를 사용하기 전에, 직접 한 번 구현해보도록 하자.
<hr/>

<h2>Redis 적용해보기</h2>

- 최대한 간단하게 Redis를 도입해보자.  
  사용자가 정보를 조회하는 API를 호출했을 때의 시나리오는 아래와 같다.
  - (1) 클라이언트의 사용자 정보 조회 요청
  - (2) Redis에 정보가 있는지 검사
  - (3-1) Redis에 정보가 있다면 그대로 반환
  - (3-2) Redis에 정보가 없다면 RDB에서 정보를 읽어온 후, 추후 요청을 위해 Redis에 저장

<h3>필요한 Spring Bean 등록하기</h3>

- Spring Boot의 Main Application에 redis를 사용하기 위한 필수적인 Spring Bean을 등록하자.

```kt
class Application {

  // 다른 설정 및 Spring Beans..

  @Bean
    fun userRedisTemplate(redisConnectionFactory: RedisConnectionFactory): RedisTemplate<String, User> {
        val redisTemplate = RedisTemplate<String, User>()
        redisTemplate.connectionFactory = redisConnectionFactory
        return redisTemplate
    }
}
```

- 우선 위 코드는 `RedisTemplate`을 Spring Bean으로 등록하는데, 제네릭 타입에 넣어준 타입들을 보면  
  `String`과 `User`가 있다. `String`은 내장 타입이며 `User`는 RDB의 users 테이블을 나타낸 Entity 객체이다.  
  위 `userRedisTemplate`은 Key의 타입이 String이고, Value에는 `User`의 타입을 지정해주었다.  
  `RedisTemplate`은 직렬화, 역직렬화를 간단히 진행할 수 있도록 해주는 Helper Class이다.

- Spring Boot의 자동 설정 덕분에 `RedisConnectionFactory`에 대한 추가적인 설정은 해줄 필요가 없다.

- 위 코드에서 직렬화를 하기에 이제 `User`는 `java.io.Serializable` 인터페이스를 구현하도록 해야 한다.

<h3>RedisRepository 작성하기</h3>

- Redis와의 데이터 처리를 담당하는 Repository 코드를 작성해보자.  
  클래스명은 `UserRedisRepository`로 했다.

```kt
@Repository
class UserRedisRepository(
    userRedisTemplate: RedisTemplate<String, User>
) {

    private var hashOperations: HashOperations<String, String, User>? = null

    init {
        hashOperations = userRedisTemplate.opsForHash()
    }

    fun save(user: User) {
        hashOperations?.put("USER", user.id!!.toString(), user)
    }

    fun findById(userId: Int): User? {
        return hashOperations?.get("USER", userId.toString())
    }
}
```

- userRedisTemplate 변수는 위에서 작성한 Spring Bean을 자동으로 의존성 주입을 받았고,  
  hashOperations 객체는 직접 생성자에서 초기화 시 만들어주었다.

-

* Application.kt
* FindUser.kt
* Screenshot
