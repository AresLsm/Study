# 비격리 문제 처리

- ACID의 격리성(I, Isolation)은 동시에 실행 중인 여러 트랜잭션의 결과가  
  어떤 순서대로 실행된 결과와 동일함을 보장하는 속성이다. 그래서 각 ACID 트랜잭션이  
  DB 데이터에 배타적으로 접근하듯이 동작하고, 개발자는 동시 실행되는 비즈니스  
  로직을 쉽게 작성할 수 있다.

- 그런데 Saga의 문제는 바로 이 `I`가 빠져 있다는 것이다.  
  실제로 Saga의 한 트랜잭션이 커밋한 변경분을 다른 Saga가 즉시 바라볼 수 있다.  
  이는 두 가지 문제를 야기한다. 첫째, **한 saga가 실행 중에 접근하는 데이터를 도중에 다른**  
  **saga가 바꿔치기할 수 있다.** 둘째, **한 saga가 업데이트를 하기 이전의 데이터를 다른 Saga가**  
  **읽을 수 있어서 데이터 일관성이 깨질 수 있다.** Saga는 사실 ACD 트랜잭션으로 봐야 한다.

  - **원자성(Atomicity)** : Saga는 트랜잭션을 모두 완료하거나 모든 변경분을 undo해야 한다.
  - **일관성(Consistency)**: 서비스 내부의 참조 무결성은 로컬 DB가, 여러 서비스에 걸친  
    참조 무결성은 서비스가 처리한다.
  - **지속성(Durability)** : 로컬 DB로 처리한다.

- 격리가 안되면 DB 용어로 _비정상(anomaly)_ 이 나타날 가능성이 있다. 트랜잭션이  
  차례대로 실행되지 않는 것처럼 데이터를 읽고 쓰게 되는 형상이다. 그래서 Saga를 동시 실행한  
  결과와 순차 실행한 결과가 달라질 수 있다.

- 비격리는 도저히 용납되지 못할 문제처럼 보이지만, 실제로 성능 향상을 위해 격리 수준을  
  낮추어 개발하는 경우가 흔하다. RDBMS는 격리 수준을 트랜잭션마다 다르게 지정할 수 있고,  
  기본적으로 완전 격리(Full Isolation)보다 약한 격리 수준을 적용한다.  
  그러나 실무에서는 ACID 트랜잭션과 다른 DB 트랜잭션을 사용할 때가 많다.

<h2>비정상 개요</h2>

- 비격리로 인한 비정상은 아래와 같이 정리할 수 있다.

  - **소실된 업데이트(lost updates)** : 한 Saga의 변경분을 다른 Saga가 미처 못 읽고  
    덮어쓴다.
  - **Dirty Reading** : Saga 업데이트를 하지 않은 변경분을 다른 트랜잭션이나 Saga가 읽기 쉽다.
  - **fuzzy/반복 불가능한 읽기(nonrepeatable reads)** : 한 Saga의 상이한 두 단계가  
    같은 데이터를 읽어도 결과가 달라지는 형상으로, 다른 Saga가 그 사이 업데이트를 했기에 생기는 문제이다.

- 소실된 업데이트, Dirty Reading은 가장 흔하지만 처리하기는 가장 까다로운 비정상 현상이다.

<h3>소실된 업데이트</h3>

- 소실된 업데이트는 한 Saga의 변경분을 다른 Saga가 덮어 쓸 때 발생한다.

  - (1) 주문 생성 Saga 첫 번째 단계에서 주문을 생성한다.
  - (2) Saga 실행 도중 주문 취소 Saga가 주문을 취소한다.
  - (3) 주문 생성 Saga의 마지막 단계에서 주문을 승인한다.

- 주문 생성 Saga는 주문 취소 Saga가 업데이트한 데이터를 덮어쓰게 되고,  
  결국 고객은 자신이 주문 취소한 음식을 배달받게 될 것이다.

<h3>Dirty Reading</h3>

- Dirty Reading은 한 Saga가 업데이트 중인 데이터를 다른 Saga가 읽을 때 발생한다.  
  예를 들어, 배달 음식 애플리케이션의 소비자는 각각 신용 한도가 정해져 있고, 주문 취소 Saga는  
  아래와 같은 트랜잭션으로 구성된다.

  - 소비자 서비스: 신용 잔고를 늘린다.
  - 주문 서비스: 주문을 취소 상태로 변경한다.
  - 배달 서비스: 배달을 취소한다.

- 주문 취소 Saga와 주문 생성 Saga의 실행이 서로 겹쳐 실행중인데, 소비자가 배달을  
  취소하기에는 너무 늦어서 주문 취소 Saga가 롤백되는 경우를 생각해보자.  
  소비자 서비스를 호출하는 트랜잭션 순서가 아래처럼 엉켜버릴 수 있을 것이다.

  - 주문 취소 Saga: 신용 잔고를 늘린다.
  - 주문 생성 Saga: 신용 잔고를 줄인다.
  - 주문 취소 Saga: 신용 잔고를 줄이는 보상 트랜잭션이 가동된다.

- 주문 생성 Saga는 Dirty Reading을 하게 되고, 소비자는 신용 한도를 초과하는 주문도  
  할 수 있게 될 것이다. 실제로 이런 일이 발생하면 매우 곤란할 것이다.

<hr/>
