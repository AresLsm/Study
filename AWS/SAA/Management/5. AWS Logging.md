# AWS Logging

## CloudWatch Logging Agent

- CloudWatch is used to collate and collect metrics on resources, monitor their performance and response to alerts.
- CloudWatch allows you to collect logs of your applications and a number of different AWS services.
- CloudWatch provides the ability to monitor log streams in real time and set up metric filters to search  
  for specific events.

### Unified CloudWatch Agent

- Unified CloudWatch Agent allows the collection of logs from EC2 instances as well from on-premise servers.

### CloudWatch Agent Installation

- (1) Create a role and attach it to the instance with permissions to collect data from the instances in addition  
  to interacting with SSM.
- (2) Download nad install the agent onto the EC2 instance.
- (3) Configure and start the CloudWatch agent.

#### Creating Roles

- Two roles are required:

  - (1) Used to install the agent and also send the additional metrics gathereed to CloudWatch.
  - (2) Used to communicate with the Parameter Store within SSM, to store a configuration information file of  
    the agent.

#### Configuring the agent

- On your first instance, you need to create the CloudWatch Agent Configuration File.

  - This file stores configuration parameters that specify which metrics and logs to capture on the instance.
  - It can be created manually or by using a wizard.
  - It is in JSON format.

- Configuration file을 SSM에 저장시켜 하나의 configuration file을 여러 개의 EC2 instance가 공유할 수 있다.

---

## CloudTrail Logging

### AWS CloudTrail

- CloudTrail records and tracks all AWS API request made.
- API requests are:

  - Programmatic requests initiated from a user using an SDK.
  - Requests from the AWS CLI.
  - Requests from within the AWS Management Console.
  - Requests made by another AWS service.

- CloudTrail capture the API request as an _'event'_ and records this event within a log file which is then  
  stored on S3. It also records other identifying metadata:
  - The identity of the caller.
  - The timestamp.
  - The source IP address.

### Log file format

- Log files are written in a JSON format.
  - When an API is captured, it is associated with an event and written to a log.
  - New logs are created every 5 minutes.
  - Logs are delivered to S3 buckets 15 minutes after the API was called.

### Log file structure

- Below are some of key attributes of an event in the log file:
  - eventName: The name of the API that was called.
  - eventSource: The service to which the API call was made against.
  - eventTime: The time that the call was made.
  - sourceIPAddress: The source IP address of the requester who made the API call.
  - userAgent: The agent method that the request was made through.
  - userIdentity: A larger set of attributes that provides information on the identity that made the API request.

### Aggregating logs from multiple AWS accounts.

- To have logs from all your accounts delivered to just one S3 bucket:

  - (1) Create a trail in the AWS Account that you want all log files to be delivered to.
  - (2) Apply permissions to the destination S3 bucket allowing cross-account access for CloudTrail.
  - (3) Create a new trail in your other AWS account and select to use an existing S3 bucket.

#### Aggregating permissions

- How to allow users to only access CloudTrail logs that originated from _their_ AWS account?

  - (1) In the master account, IAM Roles would need to be created for each of the other AWS accounts  
    requiring read access.
  - (2) A policy would need to be assigned to those Roles allowing access to the relevant AWS accounts logs ONLY.
  - (3) Users within the requesting AWS accounts would need to be able to _'Assume'_ this Role to gain read access  
    for their CloudTrail logs.

### CloudTrail log file security

- Log file integrity validation allows you to verify that your log files have remained unchanged since  
  CloudTrail delivered them to the S3 bucket.
  - Often used for security and forensic investigations.

---
