# MSA 구성 요소 및 패턴

- MSA 역시 검증된 아키텍쳐 스타일, 패턴이 존재한다.  
  개발자의 입장에서 마이크로서비스 시스템을 구현하기 위해 밟아야할 단계들을 순서대로 살펴보자.

- 우선은 `인프라가 구축`되어야 하고, 그 위에 `미들웨어`가 올라가고, 미들웨어 위에서 `애플리케이션이 동작`해야 한다.  
  따라서 `인프라`, 미들웨어 영역을 대신하고 있는 `플랫폼`, 그리고 `애플리케이션` 순으로 살펴보자.

- 먼저 클라우드 인프라 패턴이라고도 부를 수 있는 클라우드 인프라 영역의 구성요소를 살펴보자.

<table>
    <tr>
        <td>패턴 유형</td>
        <td>설명</td>
    </tr>
    <tr>
        <td>인프라 구성요소</td>
        <td>마이크로서비스를 지탱하는 하부구조 인프라를 구축하는 데 필요한 구성요소</td>
    </tr>
    <tr>
        <td>플랫폼 패턴</td>
        <td>인프라 위에서 마이크로서비스의 운영과 관리를 지원하는 플랫폼 차원의 패턴</td>
    </tr>
    <tr>
        <td>애플리케이션 패턴</td>
        <td>마이크로서비스 애플리케이션을 구성하는 데 필요한 패턴</td>
    </tr>
</table>

<hr/>

<h2>1. 인프라 구성요소</h2>

- IT에서 `인프라`라는 단어의 의미는 Enterprise IT 환경을 운영하고 관리하는 데 필요한 근간이 되는 하드웨어,  
  소프트웨어, 네트워킹 구성요소, 운영체제, 데이터 스토리지 등을 모두 포괄한다.  
  클라우드 환경에서는 이러한 인프라 구성요소들이 모두 가상화되어 제공된다.

<h3>온프레미스 vs 클라우드 환경</h3>

- AWS, GCP, Azure 등의 클라우드 서비스는 시스템의 자원 구성, 할당, 관리, 모니터링 등을 모두 제공하여  
  일련의 설정 작업들을 몇 번의 클릭만으로 처리할 수 있게 해준다.

- 이러한 환경에서 Architect가 해야하는 일은 가장 먼저 **맨 하부의 시스템의 기반이 되는 인프라 구축** 이다.  
  물론 이 과정에서 온프레미스 환경을 선택해도 된다. 하지만 가상화 장치 없이 온프레미스 환경의 장비들로 마이크로서비스  
  애플리케이션을 구동한다면 각 마이크로서비스마다 베어 메탈 장비를 구축해야 하고, 이는 당연히 인프라의 유연한  
  확장/축소를 기대하기 힘든 결과를 낼 것이다.

- 만약 가상 인프라 환경을 사용하기로 결정했다면, 그다음으로 가장 먼저 고려할 사항은 **VM 제품과 컨테이너 기반 제품 중 하나를 선택**  
  하는 것이다. 이 둘의 차이점을 알아보자.

<h3>VM, Container</h3>

- 우선, VM은 하이퍼바이저(Hypervisor)라는 소프트웨어를 이용해 하나의 시스템에서 여러 개의 OS를 사용하는 기술이다.  
  반면에 컨테이너는 하이퍼바이저 없이 컨테이너 엔진을 사용해 가상의 격리된 공간을 생성한다.

- 이 둘의 차이점은 Guest OS의 유무로 판단할 수 있는데, VM의 경우 Guest OS는 Host OS와 라이브러리(애플리케이션) 사이에  
  Hypervisor와 함께 위치하지만, 컨테이너의 경우에는 Docker Engine만이 Host OS와 라이브러리 사이에 위치한다.

- Guest OS를 사용하는 VM에는 운영체제 패치 설치나 관련 라이브러리 설치와 같은 오버헤드가 지속적으로 발생한다.  
  따라서 **마이크로서비스 같은 작은 서비스를 패키징하고 배포하기에는 컨테이너가 더 적합** 하다.

- 가장 대표적인 컨테이너 기수로는 필요한 라이브러리나 실행 파일을 여러 개의 Layer로 된 Image로 추가하거나 변경할 수 있는  
  Docker가 있다.

- Docker Container는 아래와 같은 계층으로 구성된다.

  - Image Layer 3 (Application)
  - Image Layer 2 (Runtime)
  - Image Layer 1 (OS)
  - Base Image (Base RHEL)

- Docker Container의 이점은 아래와 같다.

  - 이식성: 어떠한 호스트 커널이나 플랫폼 버전에 관계없이 Docker만 실행할 수 있으면 사용 가능하며 동일하게 동작된다.
  - 신속성: 크기가 작고 가볍기에 빠르게 배포가 가능하며, 문제 발생 시 수정할 필요 없이 새로 기동하면 된다.
  - 재사용성: 동일한 환경을 재사용해서 쉽게 설정 가능하기에 개발, 테스트, 스테이징, 프로덕트 환경을  
    동일한 환경으로 구축하기가 쉽다.

- 결론적으로 마이크로서비스와 같이 가변적이고 유연한 속성을 갖추기 위해서는 Container 기반의 아키텍쳐가 더욱 어울린다.

<h3>Container Orchestration</h3>

- 컨테이너 기술을 사용할 때에는 컨테이너를 관리하기 위한 기술 또한 필요하다.  
  컨테이너가 많아지면 그에 따라 컨테이너의 자동 배치 및 복제, 장애 복구, 확장 및 축소, 컨테이너 간의 통신,  
  로드 밸런싱 등의 컨테이너 관리를 위한 기능이 필요해진다.

- 이러한 기술을 Container Orchestration이라 하며, 이를 위한 도구로는 Docker Swarm, Apache Mesos 등이 있다.  
  최근에는 Google이 공개한 Kubernetes가 큰 인기를 끌고 있다.

- Kubernetes 대시보드를 보면 컨테이너 배포의 기본 단위에 해당하는 Pod, Deployment, Replica Set 등의  
  정보를 확인하고 설정할 수 있다. Kubernetes는 아래와 같은 주요 기능들을 제공한다.

  - Automatic Binpacking: 각 컨테이너가 필요로 하는 CPU와 메모리를 K8s에 요청하면 컨테이너를 노드에 맞춰 자동 배치한다.
  - Self-healing: 컨테이너에 대해 health check를 수행하여 실패한 경우 자동으로 교체하고 re-scheduling 한다.
  - Horizontal Scaling: 일정 CPU 및 메모리 사용량을 초과하면 자동으로 확장한다.

- 또한 Kubernetes는 일부 마이크로서비스 운영/관리 패턴을 자체적으로 내장하고 있기도 하다.

<hr/>

<h2>마이크로서비스 운영과 관리를 위한 플랫폼 패턴</h2>

- 애플리케이션이 실제로 구동되는 인프라 환경을 결정했다면 그 다음으로 선택한 인프라 환경 위에서  
  애플리케이션을 운영하고 관리하는 환경을 구성하는 방법을 생각해야 한다.  
  특히 **애플리케이션을 빌드하고 인프라에 배포할 수 있는 환경** 이 중요하다.  
  왜냐하면 마이크로서비스 환경을 구성하는 수많은 마이크로서비스들을 하나하나 빌드하고 배포한다면  
  굉장히 비효율적이고 큰 혼란을 가져올 것이기 때문이다.

 <h3>개발 지원 환경: DevOps 인프라 구성</h3>

- 필요한 요소는 마이크로서비스를 빌드하고 테스트한 뒤 배포할 수 있게 도와주는 개발환경인 DevOps 환경이다.  
  DevOps는 개발과 운영이 분리되지 않은 개발 및 운영을 병행할 수 있는 조직 또는 그 문화를 일컫는데,  
  여기서는 협의의 의미로 개발과 운영을 병행 가능하게끔 높은 품질로 소프트웨어를 빠르게 개발하도록 지원하는  
  빌드, 테스트, 배포를 위한 자동화 환경을 말한다.

- 그럼 자동화 환경이 있기 전의 수동 배포 절차를 살펴보자.

  - (1) 개발자가 개발 환경에서 애플리케이션을 완성하고, 컴파일하고 수동 테스트 후 발생한 오류를 수정한 뒤 스테이징 환경에 배포한다.
  - (2) 운영 환경 배포 전에 스테이징 환경에서 다시 테스트한다. 그러다 예상치 못한 오류를 발견하면 다시 첫 환경인 개발 환경으로 돌아가  
    오류를 수정한 뒤 다시 스테이징 환경에서 테스트를 수행한다.
  - (3) 위 과정에 무사히 끝나면 배포 승인을 받고 배포 담당자가 애플리케이션을 운영 환경에 배포한다.

- 위와 같은 수동 빌드/배포 과정에는 정말 많은 시간이 소모되며, 대부분의 경우에는 시스템 사용률이 낮은 새벽 시간대에 시스템을  
  장시간 멈추고 배포 작업을 진행하는 경우가 많다. 당연히 이러한 환경에는 비즈니스 민첩성이 높을 수가 없다.  
  특히 여러 개의 마이크로서비스를 배포해야 하는 환경에서는 배포가 잦을 수 밖에 없기에 자동화가 절실하다.

- 마이크로서비스는 당연히 각 마이크로서비스마다 Repository를 다르게 가지기에 각 서비스마다 각각의  
  CI/CD 파이프라인이 구축되어 자동화가 진행되어야 한다.
